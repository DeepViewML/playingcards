schema: '2.0'
stages:
  train:
    cmd:
    - python3 -m deepview.modelpack.trainer --load=params.yaml --dataset=dataset.yaml
      --dvclive=out --report=md
    deps:
    - path: dataset
      hash: md5
      md5: f8bbfffc75405027a4f277992f51f46d.dir
      size: 332372513
      nfiles: 2968
    - path: dataset.yaml
      hash: md5
      md5: d4ac543abadc7eaf1b8276b9959e0990
      size: 327
    params:
      params.yaml:
        ChannelShuffle: 0.01
        Flip: 0.5
        Mosaic: 0.3
        RandomBrightnessContrast: 0.2
        RandomFog: 0.01
        ShiftScaleRotate: 0.3
        ToGray: 0.2
        batch_size: 128
        compute_anchors: true
        enable_numerics_check: false
        encoding_iou: 0.3
        epochs: 100
        exponential_decay: 0
        focus: false
        initial_lr: 0.01
        iou_threshold: 0.5
        letterbox: false
        objects_size: large
        remove_background_class: false
        score_threshold: 0.45
        shape: 240,320,3
        skip_validation: 10
        task: detection
        use_power_decoder: true
        warmup_epochs: 5
        warmup_lr: 0.0001
        weighted_classification: 1.0
        weighted_localization: 1.0
        weighted_objectness: 1.0
        weights: coco
    outs:
    - path: out/best.h5
      hash: md5
      md5: 51c9b7a7f9a023c00b6a948c03b077f9
      size: 24008656
    - path: out/config.json
      hash: md5
      md5: ec66e87870a319532c3f9877a45025d0
      size: 1933
    - path: out/labels.txt
      hash: md5
      md5: 42022d602e77478b53ac78ad1d0cbcfc
      size: 76
    - path: out/last.h5
      hash: md5
      md5: ab12843aca251f33471351558ea36875
      size: 24008656
    - path: out/metrics.json
      hash: md5
      md5: 8d9aabcc5d28bf3f042d9715ebda7159
      size: 387
    - path: out/report.md
      hash: md5
      md5: b83dea5756900ff7e0f5b849f0f0d827
      size: 3998
    - path: out/static
      hash: md5
      md5: 1c0367c17f9618fff28bea05eaac10d8.dir
      size: 85403
      nfiles: 4
  validate:
    cmd:
    - deepview-validator --dataset dataset.yaml --json_out out/best.h5.results.json
      --norm unsigned --validation_score 0.25 --detection_score 0.25 --detection_iou
      0.5 --labels_file out/labels.txt -l 1 out/best.h5
    - jq -f metrics.json out/best.h5.results.json > out/best.h5.metrics.json
    - deepview-validator --dataset dataset.yaml --json_out out/best.rtm.results.json
      --norm unsigned --validation_score 0.25 --detection_score 0.25 --detection_iou
      0.5 out/best.rtm
    - jq -f metrics.json out/best.rtm.results.json > out/best.rtm.metrics.json
    deps:
    - path: dataset
      hash: md5
      md5: f8bbfffc75405027a4f277992f51f46d.dir
      size: 332372513
      nfiles: 2968
    - path: dataset.yaml
      hash: md5
      md5: d4ac543abadc7eaf1b8276b9959e0990
      size: 327
    - path: metrics.json
      hash: md5
      md5: 6c32a0a23471ab154b5681a91588df1a
      size: 472
    - path: out/best.h5
      hash: md5
      md5: 51c9b7a7f9a023c00b6a948c03b077f9
      size: 24008656
    - path: out/best.rtm
      hash: md5
      md5: 5608830f52298db0b8dc59eda3a059a2
      size: 5964168
    - path: out/labels.txt
      hash: md5
      md5: 42022d602e77478b53ac78ad1d0cbcfc
      size: 76
    outs:
    - path: out/best.h5.metrics.json
      hash: md5
      md5: 3d5fc448a62bf265d6f2a8ad55bf4200
      size: 538
    - path: out/best.rtm.metrics.json
      hash: md5
      md5: ddac32d165a07c18cdfb88b7e15fc2f6
      size: 537
  convert:
    cmd:
    - docker run -u $(id -u):$(id -g) -it --rm -v $PWD:/work deepview/converter:2.6.8
      --quantize --quant-tensor --quant_normalization unsigned --samples dataset/images/quant
      --input_type uint8 --output-type int8 --labels out/labels.txt --num_samples
      16 out/best.h5 out/best.rtm
    deps:
    - path: dataset
      hash: md5
      md5: f8bbfffc75405027a4f277992f51f46d.dir
      size: 332372513
      nfiles: 2968
    - path: dataset.yaml
      hash: md5
      md5: d4ac543abadc7eaf1b8276b9959e0990
      size: 327
    - path: out/best.h5
      hash: md5
      md5: 51c9b7a7f9a023c00b6a948c03b077f9
      size: 24008656
    - path: out/labels.txt
      hash: md5
      md5: 42022d602e77478b53ac78ad1d0cbcfc
      size: 76
    outs:
    - path: out/best.rtm
      hash: md5
      md5: 5608830f52298db0b8dc59eda3a059a2
      size: 5964168
